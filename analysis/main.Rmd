---
title: "Ambient Modeling"
author: "Nicholas Long"
date: "11/17/2017"
output: html_document
---

```{r setup, include=FALSE}
knitr::opts_chunk$set(echo = TRUE)
library(MASS)
library(relaimpo)
library(bootstrap)
library(rpart)
library(randomForest)
options(warn=-1)
```

## Background
Enter background here

## Data Analysis

```{r data-import, messages=FALSE, warnings=FALSE}
# make sure to run the ruby post_process.rb script to stitch together the results.csv file
results = read.csv('../results.csv')

# only deal with results that have no cooling and are in the months of jan, feb, mar, oct, nov, dev
results = results[ results$District.Cooling.Mass.Flow.Rate == 0 & results$Month %in% c(1, 2, 3, 10, 11, 12), ]


results = results[sample(1:nrow(results), 50000,),]
```

The deviation from setpoint. Note that this is both summer and winter. The temperatures are higher in summer than setpoint because it is in 'cooling' mode.

```{r setpoint-01}
plot(results$ambient_loop_temperature_setpoint.setpoint_temperature, 
     results$District.Heating.Outlet.Temperature, main="Outlet vs Setpoint", 
     xlab="Outlet Setpoint Temperature", ylab="Actual Outlet Temperature" )
```

## Linear Model

```{r mlm-01}
colnames(results)
y = results[,'District.Heating.Outlet.Temperature']
x = results[,c('Day.of.Week', 'Hour', 'Month', 'District.Heating.Mass.Flow.Rate', 'District.Heating.Inlet.Temperature', 'Site.Outdoor.Air.Relative.Humidity', 'Site.Outdoor.Air.Drybulb.Temperature', 'ambient_loop_temperature_setpoint.setpoint_temperature')]

drop = sample(c(1:length(y)), 0.20*length(y))
keep = setdiff(c(1:length(y)), drop)

xtest = x[drop,]
ytest = y[drop]
xmodel = x[keep,]
ymodel = y[keep]    

model = lm(ymodel ~ .,data=xmodel)
final_model = stepAIC(model, direction="both")
summary(final_model)
plot(final_model)

# cross validation
theta.fit = function(x,y){lsfit(x,y)}
theta.predict = function(fit,x){cbind(1,x)%*%fit$coef} 
X = as.matrix(xmodel)
Y = as.matrix(ymodel) 

results = crossval(X,Y,theta.fit,theta.predict,ngroup=10)
cor(Y, final_model$fitted.values)**2 
cor(Y, results$cv.fit)**2 # cross-validated R2
# cros validated was 0.97 R2

yhat = predict(final_model, newdata=xtest)
plot(ytest, yhat, main="Cross Validation of Linear Model", xlab='Actual Outlet Temperature', ylab='Modeled Outlet Temperature')
abline(a=0, b=1, col="blue")

summary(final_model)
```

For a simple model that calculates the temperature of the return for the ambient loop you can use the equation below. This was the result of the stepwise regression. I was hoping that it would remove more variables, but it obviously didn't.

    Tout,amb = 37.71 - 20.91 * day_of_week + 52.05 * Hour - 35.81 * Month + 450.66 * m_dot + 1333.66 * Tin,amb - 62.54 * RHoutside + 20.58 * Tdb,outside + 128.23 Tsetpoint,amb
  
    where:
        day_of_week = 0: sunday, 1: monday, ..., 6: saturday
        Hour: hour of day (0..23)
        Month: Month of year (1,2,3, 10,11,12)
        m_dot: Mass flow rate (kg/s)
        Tin,amb: Inlet water temperature, (deg C)
        RHoutside: Outdoor relative humidity (percent)
        Tdb,outside: Outdoor drybulb temperature (deg C)
        Tsetpoint, amb = Fix to 20 for now, but need to discuss
      
      

## Classification Tree
```{r tree-based}
fit = rpart(ymodel ~ ., method="anova", data=xmodel)
plot(fit, uniform=TRUE, main="Classification Tree for Ambient Loop Temperature")
text(fit, use.n=TRUE, all=TRUE, cex=.6)
yhat = predict(fit, newdata=xtest)
plot(ytest, yhat)
abline(a=0, b=1, col="blue")
```


## Random Forest
```{r tree-based-rf}
fit = randomForest(ymodel ~ ., data=xmodel, importance=TRUE, ntree=100)
# print(fit)
importance(fit) 
plot(fit)

yhat = predict(fit, newdata=xtest)
plot(ytest, yhat, main="Cross Validation of Random Forest", xlab='Actual Outlet Temperature', ylab='Modeled Outlet Temperature')
abline(a=0, b=1, col="blue")
```

